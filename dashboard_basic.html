<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KBI Labs - Basic Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8fafc; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; text-align: center; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { font-size: 1.2rem; opacity: 0.9; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-value { font-size: 2.5em; font-weight: bold; color: #2563eb; margin-bottom: 5px; }
        .stat-label { color: #6b7280; font-size: 0.9em; }
        .section { background: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section h2 { color: #1f2937; margin-bottom: 20px; }
        .loading { color: #6b7280; font-style: italic; }
        .error { color: #ef4444; font-weight: bold; }
        .opportunity { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #2563eb; }
        .opportunity h4 { color: #1f2937; margin-bottom: 8px; }
        .opportunity p { color: #6b7280; font-size: 0.9rem; }
        .badge { display: inline-block; background: #e0e7ff; color: #3730a3; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; margin: 2px; }
        button { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin: 5px; }
        button:hover { background: #1d4ed8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ KBI Labs Intelligence Platform</h1>
            <p>Government Contractor Intelligence Dashboard</p>
            <div style="margin-top: 15px;">
                <span id="status-indicator" style="background: #10b981; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem;">Loading...</span>
            </div>
        </div>

        <div class="stats" id="dashboard-stats">
            <div class="stat-card">
                <div class="stat-value" id="active-opportunities">-</div>
                <div class="stat-label">Active Opportunities</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="federal-websites">-</div>
                <div class="stat-label">Federal Websites</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="regulations">-</div>
                <div class="stat-label">Regulations Tracked</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="api-sources">8</div>
                <div class="stat-label">Data Sources</div>
            </div>
        </div>

        <div class="section">
            <h2>üìä System Status</h2>
            <button onclick="refreshData()">üîÑ Refresh Data</button>
            <button onclick="testAllAPIs()">üß™ Test All APIs</button>
            <div id="system-status" class="loading">Loading system status...</div>
        </div>

        <div class="section">
            <h2>üéØ Active Procurement Opportunities</h2>
            <div id="opportunities-list" class="loading">Loading opportunities...</div>
        </div>

        <div class="section">
            <h2>üèõÔ∏è Policy Intelligence</h2>
            <div id="policy-intelligence" class="loading">Loading policy data...</div>
        </div>
    </div>

    <script>
        // Global state
        let dashboardData = {
            health: null,
            intelligence: null,
            opportunities: null
        };

        // Utility functions
        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = `<div class="error">‚ùå ${message}</div>`;
        }

        function showLoading(elementId, message = 'Loading...') {
            document.getElementById(elementId).innerHTML = `<div class="loading">‚è≥ ${message}</div>`;
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return num.toLocaleString();
        }

        // API functions
        async function fetchHealthData() {
            try {
                const response = await fetch('/api/government-intelligence/health');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Health fetch error:', error);
                throw error;
            }
        }

        async function fetchComprehensiveIntelligence() {
            try {
                const response = await fetch('/api/government-intelligence/comprehensive-intelligence');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                return data.data;
            } catch (error) {
                console.error('Intelligence fetch error:', error);
                throw error;
            }
        }

        async function fetchProcurementOpportunities() {
            try {
                const response = await fetch('/api/government-intelligence/procurement-opportunities');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                return data.data;
            } catch (error) {
                console.error('Opportunities fetch error:', error);
                throw error;
            }
        }

        // Update functions
        function updateStats(intelligence) {
            const summary = intelligence.executive_summary;
            document.getElementById('active-opportunities').textContent = formatNumber(summary.active_opportunities);
            document.getElementById('federal-websites').textContent = formatNumber(summary.total_federal_websites);
            document.getElementById('regulations').textContent = formatNumber(summary.contractor_relevant_regulations);
        }

        function updateSystemStatus(health) {
            const statusDiv = document.getElementById('system-status');
            const apiCount = Object.keys(health.api_keys_available).length;
            const activeCount = Object.values(health.api_keys_available).filter(Boolean).length;
            
            statusDiv.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>Overall Status:</strong> 
                    <span style="color: ${health.overall_status === 'healthy' ? '#10b981' : '#ef4444'}">
                        ${health.overall_status.toUpperCase()}
                    </span>
                </div>
                <div><strong>API Keys Active:</strong> ${activeCount}/${apiCount}</div>
                <div><strong>Last Updated:</strong> ${new Date(health.timestamp).toLocaleString()}</div>
                <div style="margin-top: 10px;">
                    ${Object.entries(health.api_keys_available).map(([key, status]) => 
                        `<span class="badge" style="background: ${status ? '#dcfce7' : '#fee2e2'}; color: ${status ? '#166534' : '#991b1b'}">
                            ${key}: ${status ? '‚úÖ' : '‚ùå'}
                        </span>`
                    ).join('')}
                </div>
            `;
        }

        function updateOpportunities(opportunities) {
            const listDiv = document.getElementById('opportunities-list');
            const activeOpps = opportunities.active_opportunities || [];
            
            if (activeOpps.length === 0) {
                listDiv.innerHTML = '<div class="loading">No active opportunities found</div>';
                return;
            }

            listDiv.innerHTML = activeOpps.slice(0, 5).map(opp => `
                <div class="opportunity">
                    <h4>${opp.title || 'Untitled Opportunity'}</h4>
                    <p><strong>Agency:</strong> ${opp.department || opp.agency || 'N/A'}</p>
                    <p><strong>Posted:</strong> ${opp.posted_date || 'N/A'}</p>
                    <p><strong>Deadline:</strong> ${opp.response_deadline || 'N/A'}</p>
                    ${opp.naics_code ? `<span class="badge">NAICS: ${opp.naics_code}</span>` : ''}
                    ${opp.set_aside_type ? `<span class="badge">${opp.set_aside_type}</span>` : ''}
                </div>
            `).join('');
        }

        function updatePolicyIntelligence(intelligence) {
            const policyDiv = document.getElementById('policy-intelligence');
            const policy = intelligence.policy_intelligence;
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
            
            // Recent Regulations
            if (policy.recent_regulations && policy.recent_regulations.length > 0) {
                html += '<div><h3>üìã Recent Regulations</h3>';
                policy.recent_regulations.slice(0, 3).forEach(reg => {
                    html += `<div style="background: #f8f9fa; padding: 10px; margin: 8px 0; border-radius: 6px;">
                        <strong>${reg.title || 'Regulation'}</strong><br>
                        <small>Published: ${reg.publication_date || 'N/A'}</small>
                    </div>`;
                });
                html += '</div>';
            }
            
            // Congressional Activity
            if (policy.congressional_activity && policy.congressional_activity.length > 0) {
                html += '<div><h3>üèõÔ∏è Congressional Activity</h3>';
                policy.congressional_activity.slice(0, 3).forEach(bill => {
                    html += `<div style="background: #f8f9fa; padding: 10px; margin: 8px 0; border-radius: 6px;">
                        <strong>${bill.title || 'Congressional Bill'}</strong><br>
                        <small>Number: ${bill.bill_number || 'N/A'}</small>
                    </div>`;
                });
                html += '</div>';
            }
            
            html += '</div>';
            policyDiv.innerHTML = html;
        }

        // Main functions
        async function loadDashboardData() {
            console.log('Loading dashboard data...');
            
            try {
                // Update status
                document.getElementById('status-indicator').textContent = 'Loading...';
                document.getElementById('status-indicator').style.background = '#f59e0b';
                
                // Load all data
                showLoading('system-status', 'Loading system status...');
                showLoading('opportunities-list', 'Loading opportunities...');
                showLoading('policy-intelligence', 'Loading policy data...');
                
                // Fetch health data
                dashboardData.health = await fetchHealthData();
                updateSystemStatus(dashboardData.health);
                
                // Fetch intelligence data
                dashboardData.intelligence = await fetchComprehensiveIntelligence();
                updateStats(dashboardData.intelligence);
                updatePolicyIntelligence(dashboardData.intelligence);
                
                // Fetch opportunities
                dashboardData.opportunities = await fetchProcurementOpportunities();
                updateOpportunities(dashboardData.opportunities);
                
                // Update status to success
                document.getElementById('status-indicator').textContent = '‚úÖ System Operational';
                document.getElementById('status-indicator').style.background = '#10b981';
                
                console.log('Dashboard loaded successfully');
                
            } catch (error) {
                console.error('Dashboard loading error:', error);
                document.getElementById('status-indicator').textContent = '‚ùå System Error';
                document.getElementById('status-indicator').style.background = '#ef4444';
                
                showError('system-status', `Failed to load: ${error.message}`);
            }
        }

        function refreshData() {
            loadDashboardData();
        }

        function testAllAPIs() {
            window.open('/simple-test', '_blank');
        }

        // Initialize dashboard
        window.onload = function() {
            console.log('Basic dashboard initializing...');
            loadDashboardData();
        };
    </script>
</body>
</html>